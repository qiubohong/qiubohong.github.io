---
title: Vue3异步组件——Suspense和defineAsyncComponent
date: 2023-08-10 22:00:01
toc: true
tags:
    - 每日更新
    - 技术分享
---


> 做一个有温度和有干货的技术分享作者 —— [Qborfy](https://qborfy.com)

# 背景
最近在做低代码平台项目中遇到一个很容易遇到的问题，具体描述如下：

- 问题描述：低代码平台依赖的组件库，如果将一个组件库进行融合打包到平台项目中的就会导致平台在渲染页面的时候需要加载完整的组件库，从而导致页面加载了一些大部分页面不需要的组件文件
- 希望方案：页面使用到哪些组件就去动态加载组件
- 解决方案：
  - Vue的异步加载组件，`Suspense`和`defineAsyncComponent`
  - React的异步加载组件， `Suspense`和`import()`

由于低代码项目本身使用的 Vue3 框架，而且 Vue和  React的异步加载组件方案其实差异不多，所以下面以 Vue为主进行介绍。

<!-- more -->

# 基础知识

## 异步组件
在使用异步组件之前，我们需要先声明一个 Vue的异步组件，主要有以下几种方式：

第一种，采用`<script setup>`语法的，需要在 setup中 使用  await语法即可，例子如下：

```html
<script setup>
const res = await fetch(...)
const posts = await res.json()
</script>
```

第二种，声明`setup`函数增加`async`，会被识别成异步组件，具体如下：

```js
export default {
  async setup() {
    const res = await fetch(...)
    const posts = await res.json()
    return {
      posts
    }
  }
}
```

第三种，就是通过`defineAsyncComponent`函数定义异步获取的组件实例，具体如下：

```js
import { defineAsyncComponent } from 'vue'

const AsyncComp = defineAsyncComponent(() => {
  return new Promise((resolve, reject) => {
    // ...从服务器获取组件
    resolve(/* 获取到的组件 */)
  })
})
// ... 像使用其他一般组件一样使用 `AsyncComp`

```

**注意：同时Vue组件有个配置属性`suspensible`，可以用来设置`false`忽略为异步组件。**

## Suspense

> `<Suspense>` 是一个内置组件，用来在组件树中协调对异步依赖的处理。它让我们可以在组件树上层等待下层的多个嵌套异步依赖项解析完成，并可以在等待时渲染一个加载状态。 —— [Vue官方 Suspense定义](https://cn.vuejs.org/guide/built-ins/suspense.html)

`<Suspense>`解决了我们什么问题：

- 当我们有个全局 loading，就不再需要每个组件的针对自己的加载状态去写逻辑处理
- 能够更好统一处理异步组件，减少逻辑代码
- 结合路由切换 和 `<Transition>`，可以完美实现页面切换效果

目前只有异步组件才会触发`<Suspense>`状态变更。

### 使用Suspense

```html
<script lang="ts" setup>
import Aysnc from "@/components/Async.vue";

/**
 * Suspense 组件的 pending 进入挂起状态时触发
 */
 */
const pending = ()=>{
    console.log('pending')
}

/**
 * Suspense 组件的 resolve在 default 插槽完成获取新内容时触
 */
const resolve = ()=>{
    console.log('resolve')
}

/**
 * Suspense 组件的  fallback 插槽的内容显示时触发
 */
 */
const fallback = ()=>{
    console.log('fallback')
}
</script>
<template>
    <h3>测试 Supsense</h3>
    <Suspense @pending="pending" @resolve="resolve" @fallback="fallback">
        <!-- 具有深层异步依赖的组件 -->
        <aysnc />

        <!-- 在 #fallback 插槽中显示 “正在加载中” -->
        <template #fallback>
            <h1>正在加载中...</h1>
        </template>
    </Suspense>
</template>
```

其中，`Suspense`组件有三个事件分别是：

- `pending` 进入挂起状态时触发
- `fallback` 插槽的内容显示时触发
- `resolve在` default 插槽完成获取新内容时触


## defineAsyncComponent

> 定义一个异步组件，它在运行时是懒加载的。参数可以是一个异步加载函数，或是对加载行为进行更具体定制的一个选项对象。 —— [Vue异步组件](https://cn.vuejs.org/api/general.html#defineasynccomponent)





## 组合实战



# 项目实战

项目实战只有一个目的，通过异步组件实现页面的延迟和按需加载，从而提高页面的访问性能。

# 参考资料

- [Vue Suspense 组件]()
- 《Vue.js设计与实现》书中 第 13 章 异步组件与函数式组件