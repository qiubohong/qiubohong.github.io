---
title: 通过 JS 构建我们自己的 JS 解释器
date: 2023-02-18 18:00:01
toc: true
tags:
    - 每日更新
    - 技术分享
---

# 背景
这是很久之前的一个念想，当时为了加深自己对js的理解，明白js引擎是如何工作的。
于是从上网找了一个[giao-js](https://github.com/webfansplz/giao-js)，感觉还不错，因此想学习一下。

# JS引擎

之前有篇文章[理解React中Fiber架构(一)](https://qborfy.com/today/20230117.html)中有讲到浏览器进程如何渲染网页和执行js代码的，我们再复习一遍。

一个完整的web网页在浏览器显示和交互的进程（chrome为主），需要涉及到线程主要以下几个部分：

- `GUI 渲染线程`，负责渲染浏览器界面HTML元素,当界面需要重绘(Repaint)或由于某种操作引发回流(reflow)时,该线程就会执行。
- `JavaScript引擎线程`，JS内核，负责处理Javascript脚本程序。 一直等待着任务队列中任务的到来，然后解析Javascript脚本，运行代码。
- `定时触发器线程`，定时器setInterval与setTimeout所在线程，为什么要单独弄个线程处理定时器？是因为JavaScript引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确
- `事件触发线程`，用来控制事件轮询，JS引擎自己忙不过来，需要浏览器另开线程协助
- `异步http请求线程`，在`XMLHttpRequest`或`fetch`在连接后是通过浏览器新开一个线程请求， 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件放到 JavaScript引擎的处理队列中等待处理。这里需要注意`XMLHttpRequest`和`fetch`的区别，`fetch`是w3c标准化后一个专门提供给开发调用发起http的API接口，XMLHttpRequest是一个非标准化的Http请求对象，主要是可以发起http请求获取XML数据。

针对JS引擎，官方的定义是：

> JavaScript引擎是一个专门处理JavaScript脚本的虚拟机，一般会附带在网页浏览器之中。 —— [JS引擎 维基百科](https://zh.wikipedia.org/zh-hans/JavaScript%E5%BC%95%E6%93%8E)

因此，我们了解JS引擎在浏览器中的主要作用就，解析JS代码，并运行代码，那么它是怎么做到的呢？

如同我们人一样去认识一门语言，电脑也一样，当我们写了一行代码，JS引擎要识别出来，它同样去分析代码，然后确定执行，主要有以下几个步骤：

- 词法分析，主要是`分词（tokenize）`，将JS代码比较关键词（如：function、const、let等），拆出来放到解析器里
- 语法分析，主要解析（parse），主要用了预解析器和解析器
  - `预解析`会判断哪些代码需要立即执行，哪些代码不需要立即执行，需要立即执行的代码才会放到解析器里去解析
  - `解析器`，从词法分析获取关键词做标记，将代码生成一个抽象语法树，也叫AST语法树
- 生成AST语法树，AST语法树由`解析器`生成后，将会传递给到`解释器`
- 生成字节码，主要由`解释器`将AST语法树编译成字节码
- 执行代码，将字节码转成机器代码，以更快的速度在电脑中执行

# 参考资料

- [giao-js github源码](https://github.com/webfansplz/giao-js/blob/main/Article.md)
- [分享一篇可视化的JS引擎执行流程](https://cloud.tencent.com/developer/article/1886888)